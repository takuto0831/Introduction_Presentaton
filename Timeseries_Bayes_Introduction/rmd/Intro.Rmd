---
title: "Time Series Bayes Introduction"
date: "`r Sys.Date()`"
author: "Takuto Kotsubo"
output:
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    thumbnails: false
    lightbox: false
    md_extensions: -ascii_identifiers
editor_options: 
  chunk_output_type: console
---

```{r set up, message=FALSE,echo=FALSE}
# Global options
library(knitr)
opts_chunk$set(echo=TRUE,
               cache = FALSE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.width = 15,
               fig.height = 15)
opts_knit$set(width=75)
# setting directory
setwd("~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/")
# ggplot setting
library(tidyverse)
theme_set(theme_classic(base_size = 18,base_family = "Helvetica"))
```

```{r stan option, message=FALSE,echo=FALSE}
library(ggmcmc)
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

# 第0章: 使用データについて

## 杉の年輪幅の推移

- year: 1961-1930, width: 杉の年輪幅 

```{r}
library(tidyverse)
library(lubridate)
data <- read_csv(file = "~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/data/nenrin.txt",
                 col_names = FALSE) %>% 
  rename(width = X1) %>% # rename
  mutate(year = seq(1961,1990,by=1) %>% lubridate::ymd(truncated = 2L)) %>% # year
  select(year,width)

dplyr::glimpse(data)
```

## データ概要

```{r}
ggplot(data,aes(x=year, y=width)) +
  geom_line() +
  geom_point()
```

# 第1章: 状態空間モデル

## 時系列データと状態空間モデル

- 時系列データでは, ある時点の測定値とその前後の測定値との間に相関(自己相関)が生じうる. つまり, 時間的に独立ではない. このようなデータを独立のものとして扱って統計解析を行うと謝った結論を導いてしまうおそれがあります. このため, 時系列データを扱うさまざまな統計的手法が開発され, 実際に利用されている.状態空間モデルも時系列データを扱うことができる手法の一つである.

- 状態空間モデルの特徴は観測できない状態値によって, 観測データが得られると考えることである. 状態変化を表すモデルをシステムモデル, 観測値が得られる過程を説明するモデルを観測モデルと呼ぶ.

## ローカルレベルモデル

- 状態の値が少しずつ変化する
- ランダムウォーク・プラス・ノイズモデルあるいはローカルレベルモデルと呼ばれる.

$$
\begin{eqnarray}
y_t &=& \alpha_t + \epsilon_t, \quad \epsilon_t \sim Normal(0,\sigma_\epsilon^2) \\
\alpha_t &=& \alpha_{t-1} + \eta_t, \quad \eta_t \sim Normal(0,\sigma_\eta^2)
\end{eqnarray}
$$

### Rstanでローカルレベルモデル

```{r eval=FALSE}
# data
d_list <- list(N = NROW(data), # データ数
               Width = data$width) # 杉の幅
# コンパイル
model <- stan_model(
  "~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/stan/local_level.stan",
  auto_write = FALSE)
# サンプリング
fit1 <- rstan::sampling(object = model,
                        data = d_list,
                        verbose = TRUE, 
                        iter = 3000, 
                        chains = 3)
# savefile
saveRDS(fit1,"~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/fit/local_level.rds")
```

### サンプリング結果の確認

- Rhatを確認する

```{r}
fit1 <- readRDS("~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/fit/local_level.rds")
fit1
```

### 収束性の確認

```{r}
fit1 %>% traceplot()
```

### 状態値の可視化

- 状態値と95%信用区間

```{r}
fit1 %>% 
  ggs(family = "alpha") %>% 
  ci(thin_ci = c(0.025, 0.975)) %>% 
  bind_cols(data) %>% 
  ggplot(aes(x=year)) +
  geom_ribbon(aes(ymin=low,ymax=High),alpha=0.5) +
  geom_line(aes(y=width,color = "Obs")) +
  geom_line(aes(y=median,color = "State")) +
  scale_color_manual(name = "label", 
                     values = c("Obs" = "blue", "State" = "red"))
```

## トレンドモデル

- 状態の変化量(傾き)が少しずつ変化する

1. システムモデル

$$
\begin{eqnarray}
\alpha_t - \alpha_{t-1} &=& \alpha_{t-1} - \alpha_{t-2} + \eta_t \\
\alpha_t &=& 2\alpha_{t-1} - \alpha_{t-2} + \eta_t, \quad \eta_t \sim Normal(0,\sigma_\eta^2)
\end{eqnarray}
$$

2.観測モデル

$$
\begin{eqnarray}
y_t &=& \alpha_t + \epsilon_t, \quad \epsilon_t \sim Normal(0,\sigma_\epsilon^2)
\end{eqnarray}
$$

### Rstanでトレンドモデル

```{r eval=FALSE}
# data
d_list <- list(N = NROW(data), # データ数
               Width = data$width) # 杉の幅
# コンパイル
model <- stan_model(
  "~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/stan/trend.stan",
  auto_write = FALSE)
# サンプリング
fit2 <- rstan::sampling(object = model,
                        data = d_list,
                        verbose = TRUE, 
                        iter = 3000, 
                        chains = 3)
# savefile
saveRDS(fit2,"~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/fit/trend.rds")
```

### サンプリング結果の確認

- Rhatを確認する

```{r}
fit2 <- readRDS("~/Desktop/Intro_pres/Timeseries_Bayes_Introduction/fit/trend.rds")
fit2
```

### 収束性の確認

```{r}
fit2 %>% traceplot()
```

### 状態値の可視化

- 状態値と95%信用区間

```{r}
fit2 %>% 
  ggs(family = "alpha") %>% 
  ci(thin_ci = c(0.025, 0.975)) %>% 
  bind_cols(data) %>% 
  ggplot(aes(x=year)) +
  geom_ribbon(aes(ymin=low,ymax=High),alpha=0.5) +
  geom_line(aes(y=width,color = "Obs")) +
  geom_line(aes(y=median,color = "State")) +
  scale_color_manual(name = "label", 
                     values = c("Obs" = "blue", "State" = "red"))
```
